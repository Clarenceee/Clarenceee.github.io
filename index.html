<html>
<head>
  <meta http-equiv="refresh" content="180">
  <title>Extract Sensor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
  <script type="text/javascript">
	var x = document.getElementById("demo");
	var y = document.getElementById("demo2");
	var acl = new Accelerometer({frequency:60});
	var clientId = "client_id";
	var server ="outstanding-engineer.cloudmqtt.com";
	var mqtt_port = 443;
	var mqtt_destname = "SEND LA DIU";
	var client = new Paho.MQTT.Client(server, mqtt_port, clientId);
	var longtitude  = 0;
	  
	function init () {
    		client.connect({
		useSSL: true,
        	userName: "odzguzja",
        	password: "XIC7binxmQ8e",
        	onSuccess: createDevice
    		});
	}
	
	function createDevice () {
		//client.subscribe(mqtt_destname);
		//message = new Paho.MQTT.Message(mqtt_msg);
  		//message.destinationName = mqtt_destname;
  		//client.send(message);
		
		if (navigator.geolocation) {
    			navigator.geolocation.getCurrentPosition(showPosition);
			//navigator.geolocation.watchPosition(showPosition);
  		} else {
   			demo.innerHTML = "Geolocation is not supported by this browser.";
  		}
		

		function showPosition(position) {
   		
			console.log("SEND THIS");
			
			long = position.coords.longitude;
			lat = position.coords.latitude;
			//var mqtt_msg = "longitude";
			client.subscribe(mqtt_destname);
			gps = new Paho.MQTT.Message(long + "," + lat);
  			gps.destinationName = mqtt_destname;
  			client.send(gps);
		
			console.log("SEND EDY");
 			demo.innerHTML = "Latitude: " + position.coords.latitude +
  			"<br>Longitude: " + position.coords.longitude +
			"<br>Heading: " + position.coords.heading;
		
		}
	
	}

	  
	function getAcceleration(){
	

		console.log(acl);
		acl.addEventListener('reading', () => {
		demo2.innerHTML ="Acceleration along the X-axis " + acl.x + 
		"<br>Acceleration along the Y-axis " + acl.y +
		"<br>Acceleration along the Z-axis " + acl.z;
		});
		acl.start();
		
	}

	//window.addEventListener("deviceorientation", handleOrientation, true);
	function handleOrientation(event) {
		demo3.innerHTML = "<br> alpha : " + event.alpha + 
		"<br> beta : " + event.beta + "<br> gamma : " + event.gamma ;
	}
	
	var gyroscope = new Gyroscope({frequency: 60});
	
	function getGyroscope() {
		gyroscope.addEventListener('reading', ( ) => {
  		demo4.innerHTML = "Gyroscope X-axis " + gyroscope.x +
  		"<br>Gyroscope Y-axis " + gyroscope.y  + "<br>Gyroscope Z-axis " + gyroscope.z;
		});
		gyroscope.start();
	}
	
	function reachFunction(){
		if (navigator.geolocation) {
    			navigator.geolocation.getCurrentPosition(showReach);
			//navigator.geolocation.watchPosition(showPosition);
  		} else {
   			reach.innerHTML = "Geolocation is not supported by this browser.";
  		}
		
		function showReach(position) {		

			rchlong = position.coords.longitude;
			rchlat = position.coords.latitude;
			client.subscribe("REACH");
			gps = new Paho.MQTT.Message(rchlong + "," + rchlat);
  			gps.destinationName = "REACH";
  			client.send(gps);
 			alert("ALERT SENT TO CONTROL CENTER");
		}
	
	}

	function startWork() {

		var d = new Date() ;
		date = d.getDate() ;
		mon = d.getMonth();
		
		strt = new Paho.MQTT.Message("true");
  		strt.destinationName = "STARTWORKLO";
  		client.send(strt);
		start.innerHTML = "WORK STARTED" ;
		alert("WELCOME BACK TO WORK");
		document.getElementById("reach").style.display = "block";
		document.getElementById("ebye").style.display = "block";
		document.getElementById("start").style.display = "none";
	}
	
	function showData() {
  		var x = document.getElementById("data");
  		if (x.style.display === "none") {
   			 x.style.display = "block";
  		} else {
    			x.style.display = "none";
  		}
	}
	 
	function endWork() {
		end = new Paho.MQTT.Message("true");
  		end.destinationName = "ENDWORKLO";
  		client.send(end);
		ebye.innerHTML = "SEE YOU TOMORROW";
		document.getElementById("reach").style.display = "none";
		document.getElementById("start").style.display = "block";		
	}
	  
	  
  </script>
</head>
<body>
	<h1>TRC3000</h1>

	<div id = "start">
		<p>CLICK HERE TO START WORK</p>
		<button onclick="startWork()">START WORK</button>
	</div>
	
	<div id="reach"  style="display : none"><p> CLICK HERE WHEN ARRIVE </p>
		<button onclick="reachFunction()" style="margin:5px;">REACH</button>
		<button onclick="showData()" style="margin:5px;">Show Data</button>
	</div> 
	
	<div id="ebye"  style="display : none">
		<p> CLICK HERE END WORK </p>
		<button onclick="endWork()">OFFLINE</button>
	</div> 
	
 	<div id = "data" style="display : none; margin-top: 15px; ">
		<div id="demo"><br>Loading Location...</div> 
		<div id="demo2">Loading Acceleration...</div> 
		<div id="demo3">Loading Orientation...</div> 
		<div id="demo4">Loading Gyroscope...</div> 
	</div>
	
	
	<script>
		//getLocation();
		//handleOrientation();
		init();
	</script>
</body>
</html>
